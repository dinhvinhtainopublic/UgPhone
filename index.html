<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>UgPhone MOD</title>
<link rel="icon" type="image/x-icon" href="ugphonemod.ico">
<style>
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height:100%; width:100%; margin:0; padding:0; font-family:'Segoe UI',sans-serif; overflow:hidden; background:#0a0a14; position:fixed; }
  #overlay {
    position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
    backdrop-filter:blur(20px) brightness(0.85);
    background:linear-gradient(135deg,rgba(15,10,30,0.95),rgba(20,15,35,0.92));
    border:1px solid rgba(100,80,150,0.12); z-index:10; transition:opacity 0.5s ease;
  }
  .logo { width:120px; height:120px; background:url('ugphonemod.ico') no-repeat center/contain; margin-bottom:50px; animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{transform:scale(1);filter:drop-shadow(0 0 10px #b300ff);} 50%{transform:scale(1.1);filter:drop-shadow(0 0 25px #ff007f);} }
  .start-btn {
    padding:16px 48px; border:none; border-radius:18px; color:white; font-size:26px; cursor:pointer;
    background:linear-gradient(90deg,#6a00ff,#b300ff,#ff0040); background-size:200% 200%;
    animation:gradientShift 4s ease infinite; box-shadow:0 0 20px rgba(179,0,255,0.6);
    transition:transform 0.3s; text-transform:capitalize; touch-action:manipulation;
  }
  .start-btn:active{transform:scale(0.95);}
  .start-btn:hover{transform:scale(1.08);box-shadow:0 0 30px rgba(255,0,128,0.8);}
  @keyframes gradientShift{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
  .loading-text{font-size:24px;margin-top:35px;margin-left:15px;color:#b300ff;font-weight:600;animation:fadeIn 1.5s forwards;text-align:center;letter-spacing:0.5px;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(15px);}to{opacity:1;transform:translateY(0);}}
  .status-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,20,0.95);padding:8px 15px;display:none;z-index:100;border-top:1px solid rgba(179,0,255,0.3);backdrop-filter:blur(10px);flex-direction:row;justify-content:space-between;align-items:center;flex-wrap:nowrap;}
  .status-item{display:inline-flex;align-items:center;color:#b300ff;font-size:11px;white-space:nowrap;margin:0 8px;}
  .status-dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:#00ff00;margin-right:5px;animation:blink 2s infinite;flex-shrink:0;}
  @keyframes blink{0%,100%{opacity:1;}50%{opacity:0.3;}}
  iframe{width:100%;height:calc(100% - 35px);border:none;display:block;position:fixed;top:0;left:0;}
  #preloadFrame{position:absolute;width:1px;height:1px;opacity:0;pointer-events:none;top:-9999px;}
  @media (max-width:768px){
    .logo{width:100px;height:100px;margin-bottom:40px;}
    .start-btn{padding:14px 40px;font-size:22px;}
    .loading-text{font-size:20px;margin-top:30px;}
    .status-bar{padding:6px 10px;}
    .status-item{font-size:10px;margin:0 5px;}
    .status-dot{width:6px;height:6px;}
    iframe{height:calc(100% - 30px);}
  }
</style>
</head>
<body>
<div class="status-bar" id="statusBar">
  <span class="status-item"><span class="status-dot"></span>Active</span>
  <span class="status-item" id="uptime">0:00</span>
  <span class="status-item" id="wakeLockStatus">üîí‚ùå</span>
</div>
<div id="overlay">
  <div class="logo"></div>
  <button id="startBtn" class="start-btn">B·∫Øt ƒê·∫ßu</button>
  <div class="loading-text" id="statusText" style="display:none;">ƒêang T·∫£i D·ªØ Li·ªáu...</div>
</div>

<!-- Hidden preload iframe -->
<iframe id="preloadFrame" allow="autoplay; fullscreen; picture-in-picture"></iframe>
<!-- Main iframe -->
<iframe id="proxyFrame" allow="autoplay; fullscreen; picture-in-picture"></iframe>

<script src="reload-helper.js"></script>
<script>
const TARGET_URL = "https://uproxy.online/ultraviolet/hvtrs8%2F-nmw%2Cge%2Fcprs-cnuqtgr%2Cilc-9355%2Falwsvep.jtol";
const startBtn = document.getElementById('startBtn');
const overlay = document.getElementById('overlay');
const frame = document.getElementById('proxyFrame');
const preloadFrame = document.getElementById('preloadFrame');
const statusText = document.getElementById('statusText');
const statusBar = document.getElementById('statusBar');
const uptimeEl = document.getElementById('uptime');
const wakeLockStatusEl = document.getElementById('wakeLockStatus');
let wakeLock=null; let startTime=Date.now(); let audioContext=null;
let preloadAttempts = 0;
let mainLoadAttempts = 0;

// Ki·ªÉm tra tr·∫°ng th√°i t·ª´ sessionStorage
const isReloaded = sessionStorage.getItem('ugphone_reloaded') === 'true';
const isPreloaded = sessionStorage.getItem('ugphone_preloaded') === 'true';

async function requestWakeLock(){
  try{
    if('wakeLock'in navigator){
      wakeLock=await navigator.wakeLock.request('screen');
      wakeLockStatusEl.textContent='üîí‚úÖ';
      wakeLockStatusEl.style.color='#00ff00';
      wakeLock.addEventListener('release',()=>{
        wakeLockStatusEl.textContent='üîí‚ùå';
        wakeLockStatusEl.style.color='#ff0000';
      });
    }else{
      wakeLockStatusEl.textContent='üîíN/A';
    }
  }catch(err){
    wakeLockStatusEl.textContent='üîí‚ùå';
  }
}

function startSilentAudio(){
  try{
    audioContext=new(window.AudioContext||window.webkitAudioContext)();
    const o=audioContext.createOscillator();
    const g=audioContext.createGain();
    o.connect(g);
    g.connect(audioContext.destination);
    g.gain.value=0.0001;
    o.frequency.value=20;
    o.start(0);
    setInterval(()=>{
      if(audioContext.state==='suspended'){
        audioContext.resume();
      }
    },3000);
  }catch(err){}
}

function preventPageFreeze(){
  setInterval(()=>{
    Math.random()*Date.now();
  },10000);
}

function updateUptime(){
  setInterval(()=>{
    const e=Math.floor((Date.now()-startTime)/1000);
    const m=Math.floor(e/60);
    const s=e%60;
    uptimeEl.textContent=`${m}:${s.toString().padStart(2,'0')}`;
  },1000);
}

// B∆Ø·ªöC 1: Preload trong hidden iframe ƒë·ªÉ "ƒë√°nh th·ª©c" proxy
function preloadURL() {
  return new Promise((resolve, reject) => {
    console.log('[UgPhone] Preloading URL...');
    statusText.textContent = 'ƒêang kh·ªüi ƒë·ªông...';
    
    let preloadTimeout;
    let checkInterval;
    
    const cleanup = () => {
      clearTimeout(preloadTimeout);
      clearInterval(checkInterval);
      preloadFrame.removeEventListener('load', onPreload);
    };
    
    const onPreload = () => {
      console.log('[UgPhone] Preload completed');
      cleanup();
      sessionStorage.setItem('ugphone_preloaded', 'true');
      resolve();
    };
    
    // Timeout sau 8 gi√¢y
    preloadTimeout = setTimeout(() => {
      console.log('[UgPhone] Preload timeout, continuing anyway');
      cleanup();
      sessionStorage.setItem('ugphone_preloaded', 'true');
      resolve();
    }, 8000);
    
    // Ki·ªÉm tra 404 m·ªói gi√¢y
    let checkCount = 0;
    checkInterval = setInterval(() => {
      checkCount++;
      try {
        const doc = preloadFrame.contentDocument || preloadFrame.contentWindow.document;
        if (doc && doc.body) {
          const text = doc.body.innerText.toLowerCase();
          if (text.includes('404') || text.includes('does not exist')) {
            console.warn('[UgPhone] 404 in preload, will retry main load');
          } else if (text.length > 100) {
            // C√≥ n·ªôi dung th·ª±c s·ª±
            console.log('[UgPhone] Valid content in preload');
            cleanup();
            sessionStorage.setItem('ugphone_preloaded', 'true');
            resolve();
          }
        }
      } catch (e) {
        // Cross-origin ho·∫∑c ch∆∞a load xong
      }
      
      if (checkCount >= 7) {
        cleanup();
        resolve();
      }
    }, 1000);
    
    preloadFrame.addEventListener('load', onPreload, { once: true });
    preloadFrame.src = TARGET_URL;
  });
}

// B∆Ø·ªöC 2: Load v√†o iframe ch√≠nh v·ªõi retry
function loadMainIframe(attempt = 0) {
  const maxAttempts = 5;
  mainLoadAttempts = attempt;
  
  console.log(`[UgPhone] Loading main iframe (attempt ${attempt + 1}/${maxAttempts})`);
  statusText.textContent = attempt > 0 ? `ƒêang th·ª≠ l·∫°i... (${attempt + 1}/${maxAttempts})` : 'ƒêang T·∫£i D·ªØ Li·ªáu...';
  
  return new Promise((resolve, reject) => {
    let loadTimeout;
    let checkInterval;
    let hasContent = false;
    
    const cleanup = () => {
      clearTimeout(loadTimeout);
      clearInterval(checkInterval);
      frame.removeEventListener('load', onLoad);
    };
    
    const retryLoad = () => {
      cleanup();
      if (attempt < maxAttempts - 1) {
        console.log('[UgPhone] Retrying after 2 seconds...');
        // Clear iframe tr∆∞·ªõc khi retry
        frame.src = 'about:blank';
        setTimeout(() => {
          loadMainIframe(attempt + 1).then(resolve).catch(reject);
        }, 2000);
      } else {
        statusText.textContent = 'L·ªói t·∫£i trang. ƒêang th·ª≠ l·∫°i...';
        // Retry v√¥ h·∫°n cho ƒë·∫øn khi th√†nh c√¥ng
        setTimeout(() => {
          loadMainIframe(0).then(resolve).catch(reject);
        }, 3000);
      }
    };
    
    const onLoad = () => {
      console.log('[UgPhone] Main iframe load event fired');
      // ƒê·ª£i 3 gi√¢y ƒë·ªÉ ki·ªÉm tra n·ªôi dung
      setTimeout(() => {
        if (hasContent) {
          cleanup();
          sessionStorage.setItem('ugphone_loaded', 'true');
          sessionStorage.setItem('ugphone_load_time', Date.now().toString());
          console.log('[UgPhone] ‚úÖ Main iframe loaded successfully!');
          statusText.textContent = 'T·∫£i th√†nh c√¥ng!';
          resolve();
        }
      }, 3000);
    };
    
    // Timeout 15 gi√¢y
    loadTimeout = setTimeout(() => {
      console.warn('[UgPhone] Main iframe load timeout');
      retryLoad();
    }, 15000);
    
    // Ki·ªÉm tra n·ªôi dung m·ªói gi√¢y
    let checkCount = 0;
    checkInterval = setInterval(() => {
      checkCount++;
      try {
        const doc = frame.contentDocument || frame.contentWindow.document;
        if (doc && doc.body) {
          const text = doc.body.innerText.toLowerCase();
          
          if (text.includes('404') || text.includes('does not exist') || text.includes('not found')) {
            console.warn('[UgPhone] ‚ùå 404 Error detected in main iframe');
            retryLoad();
            return;
          }
          
          if (text.length > 100 || doc.body.children.length > 5) {
            hasContent = true;
            console.log('[UgPhone] Valid content detected');
          }
        }
      } catch (e) {
        // Cross-origin - gi·∫£ s·ª≠ OK
        if (checkCount > 5) {
          hasContent = true;
          console.log('[UgPhone] Cross-origin, assuming valid');
        }
      }
    }, 1000);
    
    frame.addEventListener('load', onLoad, { once: true });
    
    // Clear v√† load
    if (attempt > 0) {
      frame.src = 'about:blank';
      setTimeout(() => {
        frame.src = TARGET_URL;
      }, 500);
    } else {
      frame.src = TARGET_URL;
    }
  });
}

function hideOverlay() {
  overlay.style.opacity='0';
  setTimeout(()=>{
    overlay.style.display='none';
    statusBar.style.display='flex';
  }, 500);
}

// Kh·ªüi t·∫°o khi trang load
window.addEventListener('DOMContentLoaded', async ()=>{
  // Kh·ªüi ƒë·ªông c√°c service
  startSilentAudio(); 
  preventPageFreeze(); 
  updateUptime();
  requestWakeLock();

  if(isReloaded){
    // Sau khi b·∫•m "B·∫Øt ƒê·∫ßu"
    startBtn.style.display='none';
    statusText.style.display='block';
    
    try {
      // B∆∞·ªõc 1: Preload (n·∫øu ch∆∞a)
      if (!isPreloaded) {
        await preloadURL();
        await new Promise(r => setTimeout(r, 1000)); // ƒê·ª£i th√™m 1 gi√¢y
      }
      
      // B∆∞·ªõc 2: Load main iframe
      await loadMainIframe();
      
      // ·∫®n overlay sau khi load xong
      setTimeout(hideOverlay, 2000);
    } catch (err) {
      console.error('[UgPhone] Load error:', err);
      statusText.textContent = 'ƒêang th·ª≠ l·∫°i...';
      setTimeout(() => loadMainIframe(), 2000);
    }
    
    // X√≥a flag
    setTimeout(() => {
      sessionStorage.removeItem('ugphone_reloaded');
    }, 10000);
  } else {
    // L·∫ßn ƒë·∫ßu v√†o
    try {
      // B∆∞·ªõc 1: Preload
      await preloadURL();
      await new Promise(r => setTimeout(r, 1000));
      
      // B∆∞·ªõc 2: Load main iframe  
      await loadMainIframe();
      
      // ·∫®n overlay sau 5 gi√¢y
      setTimeout(hideOverlay, 5000);
    } catch (err) {
      console.error('[UgPhone] Initial load error:', err);
    }
  }
});

// X·ª≠ l√Ω khi b·∫•m n√∫t "B·∫Øt ƒê·∫ßu"
startBtn.addEventListener('click',(e)=>{
  e.preventDefault();
  
  // L∆∞u tr·∫°ng th√°i
  sessionStorage.setItem('ugphone_reloaded', 'true');
  sessionStorage.setItem('ugphone_reload_time', Date.now().toString());
  
  // Hi·ªÉn th·ªã loading
  startBtn.style.display='none';
  statusText.style.display='block';
  
  // Reload trang sau 500ms
  setTimeout(()=>{
    window.location.reload();
  }, 500);
});

// Cleanup
window.addEventListener('beforeunload', () => {
  if (wakeLock) wakeLock.release();
});

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && !wakeLock) {
    requestWakeLock();
  }
});
</script>
</body>
</html>